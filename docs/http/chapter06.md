---
title: 第六章：代理
date: 2021-01-18
---

[[TOC]]

Web 代理(proxy)服务器是网络的中间实体。代理位于客户端和服务器之间，扮演 “中间人”的角色，在各端点之间来回传送 HTTP 报文。
本章主要内容如下:
- 对 HTTP 代理进行解释，将其与 Web 网关进行对比，并说明如何部署代理;
- 给出一些代理所能提供的帮助;
- 说明在现实网络中是怎样部署代理以及如何将网络流量导向代理服务器;
- 说明如何配置浏览器来使用代理;
- 展示 HTTP 的代理请求，说明它们与服务器请求的区别，以及代理是如何微妙地 改变浏览器行为的;
- 解释如何通过 Via 首部和 TRACE 方法来记录报文传输路径上的代理服务器链;
- 描述基于代理的 HTTP 访问控制方法;
- 解释代理如何与客户端和服务器进行交互，每个客户端和服务器支持的特性和使用的版本都可能有所不同。

## 6.1 Web的中间实体

Web 上的代理服务器是代表客户端完成事务处理的中间人。
HTTP 的代理服务器既是 Web 服务器又是 Web 客户端。

### 6.1.1 私有和共享代理

代理服务器可以是某个客户端专用的，也可以是很多客户端共享的。单个客户端专用的代理被称为私有代理。众多客户端共享的代理被称为公共代理。

- **公共代理**

大多数代理都是公共的共享代理。集中式代理的成本效率更高，更容易管理。某些代理应用，比如高速缓存代理服务器，会利用用户间共同的请求，这样的话，汇 入同一个代理服务器的用户越多，它就越有用。

- **私有代理** 

专用的私有代理并不常见，但它们确实存在，尤其是直接运行在客户端计算机上 的时候。有些浏览器辅助产品，以及一些 ISP 服务，会在用户的 PC 上直接运行一些小型的代理，以便扩展浏览器特性，提高性能，或为免费 ISP 服务提供主机 广告。

![](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/1c7b131ba7a4431ba42ccb7e5babb6df~tplv-k3u1fbpfcp-watermark.image)

### 6.1.2 代理与网关的对比

严格来说，代理连接的是两个或多个使用相同协议的应用程序，而网关连接的则是 两个或多个使用不同协议的端点。网关扮演的是“协议转换器”的角色，即使客户 端和服务器使用的是不同的协议，客户端也可以通过它完成与服务器之间的事务 处理。

- 图a 中的中间设备是一个 HTTP 代理，因为代理与客户端和服务器之间使用 的都是 HTTP 协议。
- 图b 中的中间设备是一个 HTTP/POP 网关，因为它把 HTTP 的前台与 POP E-mail 的后端连接了起来。网关将 Web 事务转换成适当的 POP 事务，这样用户 就可以通过 HTTP 读取 E-mail 了。基于 Web 的 E-mail 程序，比如 Yahoo! 邮件 和 MSN Hotmail 都是 HTTP E-mail 网关。
![](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/fa4c4f2989594a00a55ca6b2247d5e19~tplv-k3u1fbpfcp-watermark.image)

商业化的代理服务器也会实现网关 的功能来支持 SSL 安全协议、SOCKS 防火墙、FTP 访问，以及基于 Web 的应用程序。

## 6.2 为什么使用代理

代理服务器可以实现很多有用的功能。它们可以改善安全性，提高性能，节省费用。
代理服务器可以看到并接触到所有流过的 HTTP 流量，所以代理可以监视 流量并对其进行修改，以实现很多有用的增值 Web 服务。

- **儿童过滤器**

小学在为教育站点提供无阻碍访问的同时，可以利用过滤器代理来阻止学生访问 成人内容。
![](https://p9-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/bed89c5d36ce459a84e1dbd2a2e09460~tplv-k3u1fbpfcp-watermark.image)

- **文档访问控制**

可以用代理服务器在大量 Web 服务器和 Web 资源之间实现统一的访问控制策 略，创建审核跟踪机制。这在大型企业环境或其他分布式机构中是很有用的。
在集中式代理服务器上可以对所有访问控制功能进行配置，而无需在众多由 不同组织管理、不同厂商制造、使用不同模式的 Web 服务器上进行经常性的访问控制升级。
![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/e6fe680877ab47d4adc4376d089313cb~tplv-k3u1fbpfcp-watermark.image)

- **安全防火墙**

网络安全工程师通常会使用代理服务器来提高安全性。
代理服务器会在网络中的单一安全节点上限制哪些应用层协议的数据可以流入或流出一个组织。还可以提供用来消除病毒的 Web 和 E-mail 代理使用的那种挂钩程序，以便对流量进行详细的检查。
![](https://p1-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8f3107c600ca40619b013307bae5aee2~tplv-k3u1fbpfcp-watermark.image)

- **Web缓存** 

代理缓存维护了常用文档的本地副本，并将它们按需提供，以减少缓慢且昂贵的 因特网通信。
在下图中，客户端 1 和客户端 2 会去访问附近 Web 缓存上的对象 A，而客户 端 3 和客户端 4 访问的则是原始服务器上的文档。
![](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/8f7418d53eaa48f9af261b857bb8223f~tplv-k3u1fbpfcp-watermark.image)

- **反向代理**

代理可以假扮 Web 服务器。这些被称为替代物(surrogate)或反向代理(re- verse proxy)的代理接收发给 Web 服务器的真实请求，但与 Web 服务器不同的 是，它们可以发起与其他服务器的通信，以便按需定位所请求的内容。
可以用这些反向代理来提高访问慢速 Web 服务器上公共内容时的性能。在这种 配置中，通常将这些反向代理称为服务器加速器(server accelerator)(参见图 6-7)。还可以将替代物与内容路由功能配合使用，以创建按需复制内容的分布式 网络。
![](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/b28c9f193d48476abf7e2319e740fa86~tplv-k3u1fbpfcp-watermark.image)

- **内容路由器**

代理服务器可以作为“内容路由器”使用，根据因特网流量状况以及内容类型将 请求导向特定的 Web 服务器。
内容路由器也可以用来实现各种服务级的请求。比如，如果用户或内容提供者付 费要求提供更高的性能，内容路由器可以将请求转发到附近的复制缓存，或者如果用户申请了过滤服务，还可以通过过滤代理来转发 HTTP 请求。 可以用自适应内容路由代理来构建很多有趣的服务。

- **转码器**

代理服务器在将内容发送给客户端之前，可以修改内容的主体格式。在这些数据表示法之间进行的透明转换被称为转码(transcoding)。
转码代理可以在传输 GIF 图片时，将其转换成 JPEG 图片，以减小尺寸。也可以 对图片进行压缩，或降低颜色的色彩饱和度以便在电视上观看。同样，可以对文 本文件进行压缩，并为能够使用因特网的呼机和智能手机生成小型的文本摘要 Web 页面。代理甚至可以在传输文档的过程中将其转换成外语。
![](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/5c43a783ce3844c7ac939dbd7c5e1d1d~tplv-k3u1fbpfcp-watermark.image)

显示了一个转码代理，这个代理可以将英语文本转换成西班牙语文本，将HTML 页面重新格式化为较简单的文本，以便显示在手机的小屏幕上
![](https://p6-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/9a52a42462ae423caa507009aae2639c~tplv-k3u1fbpfcp-watermark.image)

- **匿名者**

代理会主动从 HTTP 报文中删除身份特性(比如客户端 IP 地址、From 首部、Referer 首部、cookie、URI 的会话 ID)，从而提供高度的私密性和匿名性。

匿名代理会对用户报文进行下列修改以增加私密性。
- 从 User-Agent 首部删除用户的计算机与 OS 类型。
- 删除 From 首部以保护用户的 E-mail 地址。
- 删除 Referer 首部来掩盖用户访问过的其他站点。
- 删除 Cookie 首部以剔除概要信息和身份的数据。
![](https://p3-juejin.byteimg.com/tos-cn-i-k3u1fbpfcp/f61fe6f6d5084720bc488ca328718751~tplv-k3u1fbpfcp-watermark.image)

